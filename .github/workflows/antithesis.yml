name: Antithesis

on:
  workflow_call:
    secrets:
      ANTITHESIS_KEY:
        required: true

  # Just for testing - remove when done.
  pull_request:
    branches:
      - 'main'
    types:
      - opened
      - synchronize

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: wget https://apt.llvm.org/llvm.sh && chmod +x llvm.sh && sudo ./llvm.sh 16 && sudo apt-get install -y clang-16 clang-tools-16 clang-16-doc libclang-common-16-dev libclang-16-dev libclang1-16 lld-16
      - run: cd /tmp && wget https://ziglang.org/download/0.11.0/zig-0.11.0.tar.xz && tar -xf zig-0.11.0.tar.xz && cd zig-0.11.0 && mkdir build && cd build && cmake .. && make -j4
      - run: /tmp/zig-0.11.0/build/stage3/bin/zig build antithesis_workload antithesis_api install
      - run: ./tools/antithesis/scripts/build.sh ${{ github.sha }}
      - run: echo "${{ secrets.ANTITHESIS_KEY }}" > /tmp/key
      - run: ./tools/antithesis/scripts/push.sh ${{ github.sha }}
